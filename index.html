<!DOCTYPE html>
<html>
<head>
<title>Air Brush!</title>

<style type="text/css">
	html, body {
		border: 0px;
		margin: 0px;
		height: 100%;
	}
	
	#display {
		width: 100%;
		height: 100%;
		background-color: #000;
		transform: matrix(-1,0,0,1,0,0);
		-o-transform: matrix(-1,0,0,1,0,0);
		-ms-transform: matrix(-1,0,0,1,0,0);
		-moz-transform: matrix(-1,0,0,1,0,0);
		-webkit-transform: matrix(-1,0,0,1,0,0);
	}
</style>

</head>
<body>

<canvas id="display"></canvas>

<script type="text/javascript" src="script/include.js"></script>
<script type="text/javascript">

var scale = 4;
var canvas = $("#display")[0];
var ctx = canvas.getContext("2d");

function Tracker() {
	var cap;
	var pbuff;
	this.onframe = null;
	var _this = this;
	
	var hsv = [144, 99, 17];
	var tol = [40, 15, 100];

	function mask() {
		var p;
		var data = pbuff.data;
		
		for(var i=data.length-4; i >= 0; i-=4) {
			p = rgb2hsv(data[i], data[i+1], data[i+2]);
			
			if(hsv[0] - tol[0] < p[0] && p[0] < hsv[0] + tol[0] &&
			   hsv[1] - tol[1] < p[1] && p[1] < hsv[1] + tol[1] &&
			   hsv[2] - tol[2] < p[2] && p[2] < hsv[2] + tol[2]) {
				data[i] = 0;
				data[i+1] = 255;
			    data[i+2] = 0;
			    data[i+3] = 255;
			}
			else {
				data[i] = 255;
				data[i+1] = 255;
				data[i+2] = 255;
				data[i+3] = 255;
			}
		}
		
		ctx.putImageData(pbuff, 0, 0);
	}

	function sample(buff, x, y) {
		var d = buff.data;
		var o = 4 * buff.width * y + 4 * x;
		
		return [d[o], d[o+1], d[o+2], d[o+3]];
	}

	function color() {
		var size = 4;
		var sx = pbuff.width/2 - size/2;
		var sy = pbuff.height/2 - size/2;
		var ex = sx + size;
		var ey = sy + size;
		var sumr = 0, sumg = 0, sumb = 0;
		for(var y=sy; y < ey; ++y) {
			for(var x=sx; x < ex; ++x) {
				var smp = sample(pbuff, x, y);
				sumr += smp[0];
				sumg += smp[1];
				sumb += smp[2];
			}
		}
		
		szsq = size*size;
		sumr /= szsq;
		sumg /= szsq;
		sumb /= szsq;
		
		var hsv = rgb2hsv(sumr,sumg,sumb);
	}

	function process() {
		cap.captureContext2d(ctx);
		
		if(_this.onframe)
			_this.onframe(cap);
		
		pbuff = cap.captureImageData(cap.width() / scale, cap.height() / scale);
		
		mask();
		
		setTimeout(function() {
			window.requestAnimationFrame(process);
			},50
		);
	}

	this.init=function() {
		cap = new cam.Capture();
		cap.start(function(cap) {
    		if(cap) {
    			canvas.width = cap.width();
    			canvas.height = cap.height();
        		process();
        	}
		});
	}
	
	this.getCap = function() {
		return cap;
	}
}

var track = new Tracker();
track.init();
track.onframe=function(cap) {
	var cx = cap.width() >> 1;
	var cy = cap.height() >> 1;

	ctx.strokeRect(cx - 50, cy - 50, 100, 100);
}

</script>

</body>
</html>
